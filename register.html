{% extends 'base.html' %}
{% block content %}
<h2>회원가입</h2>
<form id="register-form">
    <div class="mb-3">
        <label>아이디</label>
        <input type="text" id="email" class="form-control" required placeholder="예: nnabe">
    </div>
    <div class="mb-3">
        <label>비밀번호</label>
        <input type="password" id="password" class="form-control" required>
    </div>
    <div class="mb-3">
        <label>이름 (실명)</label>
        <input type="text" id="name" class="form-control" required placeholder="예: 홍길동">
    </div>
    <button type="submit" class="btn btn-primary">가입하기</button>
</form>

<script type="module">
    import { auth, db } from "/static/firebase.js";
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const emailInput = document.getElementById('email').value;
        const passwordInput = document.getElementById('password').value;
        const name = document.getElementById('name').value;

        // 아이디 뒤에 학교 도메인 자동 추가 (예: nnabe -> nnabe@school.com)
        const email = emailInput.includes('@') ? emailInput : emailInput + '@school.com';
        // 비밀번호가 1234일 경우 6자리로 보정 (Firebase 최소 6자리 제한)
        const password = passwordInput === '1234' ? '123456' : passwordInput;

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            // 회원가입 성공 시 DB에 이름 저장
            await setDoc(doc(db, "users", userCredential.user.uid), {
                name: name,
                email: email,
                isAdmin: emailInput === 'nnabe' // nnabe 아이디는 관리자로 설정
            });
            alert("가입 환영합니다!");
            window.location.href = "/login";
        } catch (error) {
            alert("가입 실패: " + error.message);
        }
    });
</script>
{% endblock %}