{% extends 'base.html' %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-body text-center">
        <h2 class="card-title">ğŸ“… ì˜¤ëŠ˜ì˜ ì¶œì„ë¶€</h2>
        <p class="card-text">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶œì„ì„ ì™„ë£Œí•˜ì„¸ìš”.</p>
        <button id="check-btn" class="btn btn-success btn-lg w-100">ğŸ™‹â€â™‚ï¸ ì € ì™”ì–´ìš”! (ì¶œì„í•˜ê¸°)</button>
    </div>
</div>

<div class="mt-4">
    <h3>ì˜¤ëŠ˜ ì¶œì„í•œ ì¹œêµ¬ë“¤</h3>
    <ul class="list-group" id="attendee-list">
        <li class="list-group-item text-muted">ë¡œë”© ì¤‘...</li>
    </ul>
</div>

<script type="module">
    import { auth, db } from "/static/firebase.js";
    import { collection, addDoc, query, where, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹

    // ì¶œì„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    async function loadAttendance() {
        const user = auth.currentUser;
        let isAdmin = false;

        // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ê´€ë¦¬ì(nnabe)ì¸ì§€ í™•ì¸
        if (user) {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().isAdmin) {
                isAdmin = true;
            }
        }

        const q = query(collection(db, "attendance"), where("date", "==", today));
        const querySnapshot = await getDocs(q);
        const list = document.getElementById('attendee-list');
        list.innerHTML = "";

        if (querySnapshot.empty) {
            list.innerHTML = '<li class="list-group-item text-muted">ì•„ì§ ì•„ë¬´ë„ ì¶œì„í•˜ì§€ ì•Šì•˜ì–´ìš”.</li>';
            return;
        }

        querySnapshot.forEach((docSnapshot) => {
            const data = docSnapshot.data();
            const li = document.createElement('li');
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            
            const infoSpan = document.createElement('span');
            infoSpan.innerHTML = `${data.name} <span class="badge bg-primary rounded-pill">ì¶œì„ì™„ë£Œ</span>`;
            li.appendChild(infoSpan);

            // ê´€ë¦¬ìì¼ ê²½ìš°ì—ë§Œ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
            if (isAdmin) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = "btn btn-danger btn-sm";
                deleteBtn.innerText = "ì‚­ì œ";
                deleteBtn.onclick = async () => {
                    if (confirm(`${data.name} í•™ìƒì˜ ì¶œì„ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        await deleteDoc(docSnapshot.ref);
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        loadAttendance();
                    }
                };
                li.appendChild(deleteBtn);
            }
            
            list.appendChild(li);
        });
    }

    // ì¶œì„ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('check-btn').addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        // ì´ë¯¸ ì¶œì„í–ˆëŠ”ì§€ í™•ì¸
        const q = query(collection(db, "attendance"), 
                        where("date", "==", today), 
                        where("uid", "==", user.uid));
        const existing = await getDocs(q);
        
        if (!existing.empty) {
            return alert("ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„ì„ í–ˆìŠµë‹ˆë‹¤.");
        }

        // ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const userName = userDoc.exists() ? userDoc.data().name : "ì•Œ ìˆ˜ ì—†ìŒ";

        // ì¶œì„ ì €ì¥
        await addDoc(collection(db, "attendance"), {
            uid: user.uid,
            name: userName,
            date: today,
            timestamp: new Date()
        });
        alert("ì¶œì„ì²´í¬ ì™„ë£Œ!");
        loadAttendance();
    });

    // ë¡œê·¸ì¸ ìƒíƒœê°€ í™•ì¸ë˜ë©´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤ (ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ì„ ìœ„í•´)
    onAuthStateChanged(auth, (user) => {
        loadAttendance();
    });
</script>
{% endblock %}